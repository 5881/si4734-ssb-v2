/*
 * Библиотека работы с i2c oled дисплеем на SSD1306 
 * 
 * 7 апреля v0.1
 * 
 * 8 апреля 2020г
 * Добавлено масштабирование текста, ускорена очистка экрана и 
 * установка координат
 */
#include <stdint.h>
#include <string.h>
#include <libopencm3/stm32/i2c.h>
#include "oledi2c.h"


/*********************************************************************
 * Секция переменных
 *********************************************************************/
uint16_t pos=0;

//псевдо utf8
//до 00x7f ascii после кирилическая страница без перфиксов
static const char ASCII[][5] =
{{0x00, 0x00, 0x00, 0x00, 0x00} // 20  
,{0x00, 0x00, 0x5f, 0x00, 0x00} // 21 !
,{0x00, 0x07, 0x00, 0x07, 0x00} // 22 "
,{0x14, 0x7f, 0x14, 0x7f, 0x14} // 23 #
,{0x24, 0x2a, 0x7f, 0x2a, 0x12} // 24 $
,{0x23, 0x13, 0x08, 0x64, 0x62} // 25 %
,{0x36, 0x49, 0x55, 0x22, 0x50} // 26 &
,{0x00, 0x05, 0x03, 0x00, 0x00} // 27 '
,{0x00, 0x1c, 0x22, 0x41, 0x00} // 28 (
,{0x00, 0x41, 0x22, 0x1c, 0x00} // 29 )
,{0x14, 0x08, 0x3e, 0x08, 0x14} // 2a *
,{0x08, 0x08, 0x3e, 0x08, 0x08} // 2b +
,{0x00, 0x50, 0x30, 0x00, 0x00} // 2c ,
,{0x08, 0x08, 0x08, 0x08, 0x08} // 2d -
,{0x00, 0x60, 0x60, 0x00, 0x00} // 2e .
,{0x20, 0x10, 0x08, 0x04, 0x02} // 2f /
,{0x3e, 0x51, 0x49, 0x45, 0x3e} // 30 0
,{0x00, 0x42, 0x7f, 0x40, 0x00} // 31 1
,{0x42, 0x61, 0x51, 0x49, 0x46} // 32 2
,{0x21, 0x41, 0x45, 0x4b, 0x31} // 33 3
,{0x18, 0x14, 0x12, 0x7f, 0x10} // 34 4
,{0x27, 0x45, 0x45, 0x45, 0x39} // 35 5
,{0x3c, 0x4a, 0x49, 0x49, 0x30} // 36 6
,{0x01, 0x71, 0x09, 0x05, 0x03} // 37 7
,{0x36, 0x49, 0x49, 0x49, 0x36} // 38 8
,{0x06, 0x49, 0x49, 0x29, 0x1e} // 39 9
,{0x00, 0x36, 0x36, 0x00, 0x00} // 3a :
,{0x00, 0x56, 0x36, 0x00, 0x00} // 3b ;
,{0x08, 0x14, 0x22, 0x41, 0x00} // 3c <
,{0x14, 0x14, 0x14, 0x14, 0x14} // 3d =
,{0x00, 0x41, 0x22, 0x14, 0x08} // 3e >
,{0x02, 0x01, 0x51, 0x09, 0x06} // 3f ?
,{0x32, 0x49, 0x79, 0x41, 0x3e} // 40 @
,{0x7e, 0x11, 0x11, 0x11, 0x7e} // 41 A
,{0x7f, 0x49, 0x49, 0x49, 0x36} // 42 B
,{0x3e, 0x41, 0x41, 0x41, 0x22} // 43 C
,{0x7f, 0x41, 0x41, 0x22, 0x1c} // 44 D
,{0x7f, 0x49, 0x49, 0x49, 0x41} // 45 E
,{0x7f, 0x09, 0x09, 0x09, 0x01} // 46 F
,{0x3e, 0x41, 0x49, 0x49, 0x7a} // 47 G
,{0x7f, 0x08, 0x08, 0x08, 0x7f} // 48 H
,{0x00, 0x41, 0x7f, 0x41, 0x00} // 49 I
,{0x20, 0x40, 0x41, 0x3f, 0x01} // 4a J
,{0x7f, 0x08, 0x14, 0x22, 0x41} // 4b K
,{0x7f, 0x40, 0x40, 0x40, 0x40} // 4c L
,{0x7f, 0x02, 0x0c, 0x02, 0x7f} // 4d M
,{0x7f, 0x04, 0x08, 0x10, 0x7f} // 4e N
,{0x3e, 0x41, 0x41, 0x41, 0x3e} // 4f O
,{0x7f, 0x09, 0x09, 0x09, 0x06} // 50 P
,{0x3e, 0x41, 0x51, 0x21, 0x5e} // 51 Q
,{0x7f, 0x09, 0x19, 0x29, 0x46} // 52 R
,{0x46, 0x49, 0x49, 0x49, 0x31} // 53 S
,{0x01, 0x01, 0x7f, 0x01, 0x01} // 54 T
,{0x3f, 0x40, 0x40, 0x40, 0x3f} // 55 U
,{0x1f, 0x20, 0x40, 0x20, 0x1f} // 56 V
,{0x3f, 0x40, 0x38, 0x40, 0x3f} // 57 W
,{0x63, 0x14, 0x08, 0x14, 0x63} // 58 X
,{0x07, 0x08, 0x70, 0x08, 0x07} // 59 Y
,{0x61, 0x51, 0x49, 0x45, 0x43} // 5a Z
,{0x00, 0x7f, 0x41, 0x41, 0x00} // 5b [
,{0x02, 0x04, 0x08, 0x10, 0x20} // 5c ¥
,{0x00, 0x41, 0x41, 0x7f, 0x00} // 5d ]
,{0x04, 0x02, 0x01, 0x02, 0x04} // 5e ^
,{0x40, 0x40, 0x40, 0x40, 0x40} // 5f _
,{0x00, 0x01, 0x02, 0x04, 0x00} // 60 `
,{0x20, 0x54, 0x54, 0x54, 0x78} // 61 a
,{0x7f, 0x48, 0x44, 0x44, 0x38} // 62 b
,{0x38, 0x44, 0x44, 0x44, 0x20} // 63 c
,{0x38, 0x44, 0x44, 0x48, 0x7f} // 64 d
,{0x38, 0x54, 0x54, 0x54, 0x18} // 65 e
,{0x08, 0x7e, 0x09, 0x01, 0x02} // 66 f
,{0x0c, 0x52, 0x52, 0x52, 0x3e} // 67 g
,{0x7f, 0x08, 0x04, 0x04, 0x78} // 68 h
,{0x00, 0x44, 0x7d, 0x40, 0x00} // 69 i
,{0x20, 0x40, 0x44, 0x3d, 0x00} // 6a j 
,{0x7f, 0x10, 0x28, 0x44, 0x00} // 6b k
,{0x00, 0x41, 0x7f, 0x40, 0x00} // 6c l
,{0x7c, 0x04, 0x18, 0x04, 0x78} // 6d m
,{0x7c, 0x08, 0x04, 0x04, 0x78} // 6e n
,{0x38, 0x44, 0x44, 0x44, 0x38} // 6f o
,{0x7c, 0x14, 0x14, 0x14, 0x08} // 70 p
,{0x08, 0x14, 0x14, 0x18, 0x7c} // 71 q
,{0x7c, 0x08, 0x04, 0x04, 0x08} // 72 r
,{0x48, 0x54, 0x54, 0x54, 0x20} // 73 s
,{0x04, 0x3f, 0x44, 0x40, 0x20} // 74 t
,{0x3c, 0x40, 0x40, 0x20, 0x7c} // 75 u
,{0x1c, 0x20, 0x40, 0x20, 0x1c} // 76 v
,{0x3c, 0x40, 0x30, 0x40, 0x3c} // 77 w
,{0x44, 0x28, 0x10, 0x28, 0x44} // 78 x
,{0x0c, 0x50, 0x50, 0x50, 0x3c} // 79 y
,{0x44, 0x64, 0x54, 0x4c, 0x44} // 7a z
,{0x00, 0x08, 0x36, 0x41, 0x00} // 7b {
,{0x00, 0x00, 0x7f, 0x00, 0x00} // 7c |
,{0x00, 0x41, 0x36, 0x08, 0x00} // 7d }
,{0x10, 0x08, 0x08, 0x10, 0x08} // 7e ←
,{0x78, 0x46, 0x41, 0x46, 0x78} // 7f →
,{0x7C, 0x14, 0x14, 0x14, 0x08}//p  0x80
,{0x38, 0x44, 0x44, 0x44, 0x20}//c  0x81
,{0x04, 0x04, 0x7c, 0x04, 0x04}//т  0x82
,{0x0C, 0x50, 0x50, 0x50, 0x3C}//у  0x83
,{0x30, 0x48, 0xfc, 0x48, 0x30}//ф  0x84
,{0x44, 0x28, 0x10, 0x28, 0x44}//x  0x85
,{0x7c, 0x40, 0x40, 0x40, 0xfc}//ц  0x86
,{0x0c, 0x10, 0x10, 0x10, 0x7c}//ч  0x87
,{0x7c, 0x40, 0x7c, 0x40, 0x7c}//ш  0x88
,{0x7c, 0x40, 0x7c, 0x40, 0xfc}//щ  0x89
,{0x04, 0x7c, 0x50, 0x50, 0x20}//ъ  0x8A
,{0x7c, 0x50, 0x50, 0x20, 0x7c}//ы  0x8B
,{0x7c, 0x50, 0x50, 0x20, 0x00}//ь  0x8C
,{0x28, 0x44, 0x54, 0x54, 0x38}//э  0x8D
,{0x7c, 0x10, 0x38, 0x44, 0x38}//ю  0x8E
,{0x08, 0x54, 0x34, 0x14, 0x7c}//я  0x8F
,{0x7e, 0x11, 0x11, 0x11, 0x7e}//A  0x90
,{0x7f, 0x49, 0x49, 0x49, 0x33}//Б  0x91
,{0x7f, 0x49, 0x49, 0x49, 0x36}//В  0x92
,{0x7f, 0x01, 0x01, 0x01, 0x03}//Г  0x93
,{0xe0, 0x51, 0x4f, 0x41, 0xff}//Д  0x94
,{0x7f, 0x49, 0x49, 0x49, 0x41}//E  0x95
,{0x77, 0x08, 0x7f, 0x08, 0x77}//Ж  0x96
,{0x41, 0x49, 0x49, 0x49, 0x36}//З  0x97
,{0x7f, 0x10, 0x08, 0x04, 0x7f}//И  0x98
,{0x7c, 0x21, 0x12, 0x09, 0x7c}//Й  0x99
,{0x7f, 0x08, 0x14, 0x22, 0x41}//K  0x9A
,{0x20, 0x41, 0x3f, 0x01, 0x7f}//Л  0x9B
,{0x7f, 0x02, 0x0c, 0x02, 0x7f}//M  0x9C
,{0x7f, 0x08, 0x08, 0x08, 0x7f}//H  0x9D
,{0x3e, 0x41, 0x41, 0x41, 0x3e}//O  0x9E
,{0x7f, 0x01, 0x01, 0x01, 0x7f}//П  0x9F
,{0x7f, 0x09, 0x09, 0x09, 0x06}//P  0xa0
,{0x3e, 0x41, 0x41, 0x41, 0x22}//C  0xa1
,{0x01, 0x01, 0x7f, 0x01, 0x01}//T  0xa2
,{0x47, 0x28, 0x10, 0x08, 0x07}//У  0xa3
,{0x1c, 0x22, 0x7f, 0x22, 0x1c}//Ф  0xa4
,{0x63, 0x14, 0x08, 0x14, 0x63}//X  0xa5
,{0x7f, 0x40, 0x40, 0x40, 0xff}//Ц  0xa6
,{0x07, 0x08, 0x08, 0x08, 0x7f}//Ч  0xa7
,{0x7f, 0x40, 0x7f, 0x40, 0x7f}//Ш  0xa8
,{0x7f, 0x40, 0x7f, 0x40, 0xff}//Щ  0xa9
,{0x01, 0x7f, 0x48, 0x48, 0x30}//Ъ  0xaA
,{0x7f, 0x48, 0x30, 0x00, 0x7f}//Ы  0xaB
,{0x00, 0x7f, 0x48, 0x48, 0x30}//Э  0xaC
,{0x22, 0x41, 0x49, 0x49, 0x3e}//Ь  0xaD
,{0x7f, 0x08, 0x3e, 0x41, 0x3e}//Ю  0xaE
,{0x46, 0x29, 0x19, 0x09, 0x7f}//Я  0xaF
,{0x20, 0x54, 0x54, 0x54, 0x78}//a  0xb0
,{0x3c, 0x4a, 0x4a, 0x49, 0x31}//б  0xb1
,{0x7c, 0x54, 0x54, 0x28, 0x00}//в  0xb2
,{0x7c, 0x04, 0x04, 0x04, 0x0c}//г  0xb3
,{0xe0, 0x54, 0x4c, 0x44, 0xfc}//д  0xb4
,{0x38, 0x54, 0x54, 0x54, 0x18}//e  0xb5
,{0x6c, 0x10, 0x7c, 0x10, 0x6c}//ж  0xb6
,{0x44, 0x44, 0x54, 0x54, 0x28}//з  0xb7
,{0x7c, 0x20, 0x10, 0x08, 0x7c}//и  0xb8
,{0x7c, 0x41, 0x22, 0x11, 0x7c}//й  0xb9
,{0x7c, 0x10, 0x28, 0x44, 0x00}//к  0xbA
,{0x20, 0x44, 0x3c, 0x04, 0x7c}//л  0xbB
,{0x7c, 0x08, 0x10, 0x08, 0x7c}//м  0xbC
,{0x7c, 0x10, 0x10, 0x10, 0x7c}//н  0xbD
,{0x38, 0x44, 0x44, 0x44, 0x38}//o  0xbE
,{0x7c, 0x04, 0x04, 0x04, 0x7c}//п  0xbF
};

uint8_t ssd1306_init[18]={0xA8,0x3F,0xD3,0x00,0x40,0xA1,0xC8,0xDA,0x12,
	0x81,0x7F,0xA4,0xA6,0xD5,0x80,0x8D,0x14,0xAF,};
  
 /********************************************************************
  * Секция основных функций
  ********************************************************************/
void oled_init(void){
	oled_send_cmd2(ssd1306_init,18);//массив команд инициализации
	//i2c_transfer7(I2C1, OLEDADDR, init_cmd, 36, 0, 0);
	oled_send_cmd(0x20);//режим адресации
	oled_send_cmd(0x00);
	oled_set_col_block(0,127,0,7);
	}
//**********************************************************************
//Функции низкоуровневого обращения к oled дисплею

void oled_send_cmd(uint8_t cmd){
	uint8_t temp[2];
	temp[0]=0x80;
	temp[1]=cmd;
	i2c_transfer7(OLEDI2C,OLEDADDR,temp,2,0,0);
	}


static void wait_i2c(void){
	bool wait = true;
	while (wait) {
		if (i2c_transmit_int_status(OLEDI2C))wait = false;
		while (i2c_nack(OLEDI2C)); /* FIXME Some error */
		}
}
void oled_send_cmd2(uint8_t *cmd, uint16_t n){
	//Здесь пришлось чуть перепелить код из libopencm3
	i2c_set_7bit_address(OLEDI2C, OLEDADDR);
	i2c_set_write_transfer_dir(OLEDI2C);
	i2c_set_bytes_to_transfer(OLEDI2C, 2*n);//!!!!
	i2c_enable_autoend(OLEDI2C);
	i2c_send_start(OLEDI2C);
    for (size_t i = 0; i < n; i++){
		wait_i2c();
		i2c_send_data(OLEDI2C, 0x80);
		wait_i2c();
		i2c_send_data(OLEDI2C, *cmd++);
		}
	}

void oled_send_data2(uint8_t *data, uint16_t n){
	//Здесь пришлось чуть перепелить код из libopencm3
	i2c_set_7bit_address(OLEDI2C, OLEDADDR);
	i2c_set_write_transfer_dir(OLEDI2C);
	i2c_set_bytes_to_transfer(OLEDI2C, n+1);//!!!!
	i2c_enable_autoend(OLEDI2C);
	i2c_send_start(OLEDI2C);
    
     //Засылаем байт заголовка данных 0x40 DATAS
    wait_i2c();
	i2c_send_data(OLEDI2C, 0x40);
	//отправляем данные
	for (size_t i = 0; i < n; i++) {
		wait_i2c();
		i2c_send_data(OLEDI2C, *data++);
		}
	}
	
	
void oled_send_n_bytes_data(uint8_t byte, uint8_t n){
	//Здесь пришлось чуть перепелить код из libopencm3
	i2c_set_7bit_address(OLEDI2C, OLEDADDR);
	i2c_set_write_transfer_dir(OLEDI2C);
	i2c_set_bytes_to_transfer(OLEDI2C, n+1);//!!!!
	i2c_enable_autoend(OLEDI2C);
	i2c_send_start(OLEDI2C);
    //Засылаем байт заголовка данных 0x40 DATAS
   	wait_i2c();
	i2c_send_data(OLEDI2C, 0x40);
	//отправляем данные
	for (size_t i = 0; i < n; i++) {
		//while(!(I2C_ISR(OLEDI2C) & I2C_ISR_TC));
		wait_i2c();
		i2c_send_data(OLEDI2C, byte);
		}
	}


//void oled_send_data(uint8_t data){
//	uint8_t temp[2];
//	temp[0]=0xc0;
//	temp[1]=data;
//	i2c_transfer7(OLEDI2C,OLEDADDR,temp,2,0,0);
//	}
	

//*********************************************************************



void oled_set_col_block(uint8_t start_col,uint8_t end_col,
					uint8_t start_row, uint8_t end_row){
	uint8_t temp[6];
	temp[0]=0x21;//set col
	temp[1]=start_col;					
	temp[2]=end_col;			
	temp[3]=0x22;//set page				
	temp[4]=start_row;					
	temp[5]=end_row;
	oled_send_cmd2(temp, 6);				
	/*						
	oled_send_cmd(0x21);//set col
	oled_send_cmd(start_col); //start col
	oled_send_cmd(end_col);   //end col
	oled_send_cmd(0x22);//set page
	oled_send_cmd(start_row);//start page
	oled_send_cmd(end_row);//end page
	*/
	}

void oled_draw_dot_at(uint8_t x, uint8_t y){
	uint8_t col,row,dop_row,byte;
	col=x;
	row=y/8;
	dop_row=y%8;
	oled_set_col_block(col,col,row,row);
	byte=1<<dop_row;
	
	}

void oled_draw_char_at(uint8_t col, uint8_t row, uint8_t ch, uint8_t inv){
	//добавлена поддержка кирилицы
	uint8_t temp[6];
	unsigned char c=(ch<0xe0) ? ch - 0x20 : ch - 0x50;
	oled_set_col_block(col,col+5,row,row);
	memcpy(temp, ASCII[c] ,5);
	temp[5]=0;
	if(inv) for(uint8_t i=0;i<6;i++) temp[i]=~temp[i];
	oled_send_data2(temp,6);
	}

void oled_draw_char_x2_at(uint8_t col, uint8_t row, uint8_t ch, uint8_t inv){
	uint8_t i,j,n,hi,lo;
	uint16_t out;
	uint8_t temp[24];
	//добавлена поддержка кирилицы
	unsigned char c=(ch<0xe0) ? ch - 0x20 : ch - 0x50;
	oled_set_col_block(col,col+11,row,row+1);
	//Здесь происходит масштабирование текста в два раза
	for(j=0;j<5;j++){
		i=7;
		do{
			out<<=2;
			if((ASCII[c][j]>>i)&1) out|=0b11;
			}while(i--);
		hi=out>>8;
		lo=out&0xff;
		n=2*j;
		temp[n]=lo;
		temp[n+1]=lo;
		temp[n+12]=hi;
		temp[n+13]=hi;
		}
	temp[10]=0;
	temp[11]=0;
	temp[22]=0;
	temp[23]=0;
	if(inv) for(i=0;i<24;i++)temp[i]=~temp[i];
	oled_send_data2(temp,24);
	}
	
void oled_draw_char_x3_at(uint8_t col, uint8_t row, uint8_t ch, uint8_t inv){
	uint8_t i,j,n,hi,mi,lo;
	uint32_t out;
	uint8_t temp[54];
	//добавлена поддержка кирилицы
	unsigned char c=(ch<0xe0) ? ch - 0x20 : ch - 0x50;
	oled_set_col_block(col,col+17,row,row+2);
	//Здесь происходит масштабирование текста в три раза
	out=0;
	for(j=0;j<5;j++){
		i=7;
		do{
			out<<=3;
			if((ASCII[c][j]>>i)&1) out|=0b111;
			}while(i--);
		hi=out>>16;
		mi=(out>>8)&0xff;
		lo=out&0xff;
		n=3*j;
		temp[n]=lo;
		temp[n+1]=lo;
		temp[n+2]=lo;
		temp[n+18]=mi;
		temp[n+19]=mi;
		temp[n+20]=mi;
		temp[n+36]=hi;
		temp[n+37]=hi;
		temp[n+38]=hi;
		}
	temp[15]=0;
	temp[16]=0;
	temp[17]=0;
	temp[33]=0;
	temp[34]=0;
	temp[35]=0;
	temp[51]=0;
	temp[52]=0;
	temp[53]=0;
	if(inv) for(i=0;i<54;i++)temp[i]=~temp[i];
	oled_send_data2(temp,54);
	}
	

void oled_string_at(unsigned char col,unsigned char row,
				unsigned char *chr,	uint8_t inv){
	unsigned char i=0;
	while(*chr){
		if(*chr=='\n'){row++;chr++;i=0;}
		if(*chr==0xd0||*chr==0xd1){chr++; continue;};//поддержка урезаной utf-8
		oled_draw_char_at(col+i,row,*chr++,inv);
		i+=6;
		}
	}


void oled_string_x2_at(unsigned char col,unsigned char row,
				unsigned char *chr,	uint8_t inv){
	unsigned char i=0;
	while(*chr){
		if(*chr=='\n'){row+=2;chr++;i=0;}
		if(*chr==0xd0||*chr==0xd1){chr++; continue;};//поддержка урезаной utf-8
		oled_draw_char_x2_at(col+i,row,*chr++,inv);
		i+=12;
		}
	}

void oled_string_x3_at(unsigned char col,unsigned char row,
				unsigned char *chr,	uint8_t inv){
	unsigned char i=0;
	while(*chr){
		if(*chr=='\n'){row+=3;chr++;i=0;}
		if(*chr==0xd0||*chr==0xd1){chr++; continue;};//поддержка урезаной utf-8
		oled_draw_char_x3_at(col+i,row,*chr++,inv);
		i+=18;
		}
	}

void oled_clear(void){
	oled_set_col_block(0,127,0,8);
	//for(uint16_t i=0;i<128*8;i++)oled_send_data(0x00);
	//for(uint32_t i=0;i<0xffff;i++)__asm__("nop");
	//oled_send_n_bytes_data(0x00, 128*8);
	for(uint8_t i=0;i<8;i++){
			oled_send_n_bytes_data(0x00,128);
		}
	pos=0;
	}

void oled_ascii_tst(void){
	oled_set_col_block(0,127,0,7);
	oled_send_data2(ASCII,0xcf*5);
	}

void oled_send_char(char ch){
	//128*64
	//для символов 6*8 это 21*8
	if(ch==0xd0||ch==0xd1) return;//урезанная поддержка utf8
	uint16_t px,py;
	uint16_t col,row;

	if(ch=='\r'){
		pos-=pos%21;
		return;}
	
	if(ch=='\n'){
		pos+=21;
		pos-=pos%21;
		return;}
	
	if(ch=='\a'){
		pos=0;
		oled_clear();
		return;}
		
	if(ch=='\b'){//backspase new!
		pos--;
		col=pos%21*6;
		row=pos/26;
		oled_draw_char_at(col,row,0x20,0);
		return;}
		
	if(pos>CHAR_ON_SCREEN){ //21*8=168 
		oled_clear();
		pos=0;
		}
		
	col=pos%21*6;
	row=pos/21;

	oled_draw_char_at(col,row,ch,0);
	pos++;
	}

